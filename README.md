# Смотреть другую ветку branch 2 
## Перед запуском проекта рекомендуется проверить:
1. Обновить maven зависимости в pom.xml;
2. На каком порту висит mysql и при необходимости изменить эти параметры в файлах application.yaml, liquibase.properties.
3. Поменять логины и пароли на свои.

## Общая информация:
1. Лемматизатор (класс LemmaFinder) был скинут в проект без изменений.
2. Тесты сделаны на ApiController и некоторые методы сервиса.
3. Вся бизнес-логика сервиса находится в классе SiteIndexingService в директории service.
4. В зависимости какое у вас железо, вы можете менять параметры индексации в файле конфигурации application.yaml.
5. Текущий уровень логирования позволяет увидеть в консоли что происходит во время индексации.


# Описание сервиса SiteIndexingService

`SiteIndexingService` представляет собой сервис для индексации веб-сайтов и извлечения ключевых слов (лемм) для последующего поиска. Ниже приведено подробное описание переменных и методов в этом сервисе.


Здесь изображение диаграммы [взаимодействия классов в сервисе](images/searchengine.png).




## Переменные

### Кеши

#### `pageUrlCache`

Кэш для URL страниц, использующий библиотеку Caffeine для хранения до 600 элементов с временем жизни 10 минут.

#### `lemmaCache`

Кэш для лемм, также использующий библиотеку Caffeine, с максимальным размером 10000 элементов и временем жизни 10 минут.

### Флаги состояния индексации

#### `stopRequested`

Флаг, указывающий на запрос остановки индексации.

#### `indexingInProgress`

Флаг, показывающий, идет ли в данный момент процесс индексации.

### Другие переменные

#### `parallelism`

Количество параллельных потоков в пуле ForkJoinPool для выполнения индексации.

## Методы

### `startIndexing`

Метод для начала индексации списка сайтов. Запускает процесс индексации для каждого сайта в отдельном потоке.

### `stopIndex`

Метод для остановки текущего процесса индексации. Устанавливает флаг `stopRequested`, чтобы остановить выполнение индексации на следующем возможном шаге.

### `indexSites`

Метод для индексации списка сайтов. Использует ForkJoinPool для параллельной обработки каждого сайта из списка.

### `clearCache`

Метод для очистки кэшей `pageUrlCache` и `lemmaCache`. Вызывается для освобождения памяти после завершения индексации.

### `indexSite`

Метод для индексации конкретного сайта. Извлекает содержимое страниц сайта, извлекает ключевые слова (леммы) и сохраняет их в кэше.

### `normalizeUrl`

Метод для нормализации URL-адреса. Приводит URL к стандартному формату, учитывая протокол, домен и путь.

### `visitPage`

Метод для посещения страницы сайта и извлечения контента. Использует библиотеку для HTTP-запросов для получения HTML-кода страницы.

### `isFileUrl`

Метод для проверки, является ли URL файлом. Определяет тип ссылки (страница или файл) на основе расширения файла в URL.

### `createPageEntity`

Метод для создания объекта `PageEntity` на основе HTML-контента страницы. Извлекает заголовок, мета-теги и основное содержимое страницы.

### `extractLinksAndIndexPages`

Метод для извлечения ссылок со страницы и их последующей индексации. Извлекает все ссылки с HTML-страницы и добавляет их в список индексации.

### `getOrCreateLemma`

Метод для получения или создания сущности леммы. Проверяет наличие леммы в кэше и создает новую, если она отсутствует.

### `saveLemmasAndIndices`

Метод для сохранения лемм и индексов. Сохраняет извлеченные леммы и индексы в кэш для последующего использования при поиске.

### `isInternalLink`

Метод для проверки, является ли ссылка внутренней для сайта. Определяет, принадлежит ли ссылка тому же домену, что и сайт, или ведет на внешний ресурс.

### `updateSiteStatus`

Метод для обновления статуса сайта после индексации. Устанавливает флаги и записывает результаты индексации в базу данных.

### `indexPage`

Метод для индексации отдельной страницы по её URL. Извлекает ключевые слова (леммы) и сохраняет их в кэше.

### `performSearch`

Метод для выполнения поиска по заданному запросу и сайту. Использует сохраненные леммы и индексы для быстрого поиска соответствующих страниц.

### `sortLemmasByFrequency`

Метод для сортировки лемм по частоте их использования. Позволяет оптимизировать поиск, упорядочивая наиболее часто встречающиеся ключевые слова.

### `filterFrequentLemmas`

Метод для фильтрации часто встречающихся лемм. Уменьшает размер индекса, исключая наиболее общие ключевые слова.

### `findPagesByLemmas`

Метод для поиска страниц по заданным леммам и сайту. Использует индексы для быстрого поиска страниц, содержащих заданные ключевые слова.

### `calculateRelevance`

Метод для расчёта релевантности страницы по заданным леммам. Оценивает, насколько страница соответствует запросу пользователя на основе наличия ключевых слов.

### `createSearchResult`

Метод для создания объекта `SearchResultDto` на основе страницы и релевантности. Формирует структуру данных для отображения результатов поиска пользователю.


Данный список методов представляет основные функции сервиса `SiteIndexingService`, включая индексацию, поиск и обработку данных.



# Проект SearchEngine

Описание зависимостей в pom.xml.

## Зависимости

### Spring Boot Starter Parent
Parent POM для Spring Boot приложений. Управляет версиями зависимостей и предоставляет базовую конфигурацию.

### Spring Boot Starter Web
Включает необходимые библиотеки для разработки веб-приложений на Spring, включая веб-контроллеры и HTTP клиенты.

### Spring Boot Starter Thymeleaf
Интеграция с Thymeleaf, шаблонизатором для создания веб-интерфейсов в Spring приложениях.

### Lombok
Уменьшает объем кода за счет автоматической генерации методов, таких как геттеры, сеттеры и конструкторы, через аннотации.

### Liquibase Core
Позволяет управлять миграциями базы данных с использованием changelog файлов.

### MySQL Connector Java
Драйвер JDBC для взаимодействия с MySQL базой данных.

### Spring Boot Starter Data JPA
Интеграция Spring Data JPA для удобного доступа и управления данными в базе данных с использованием Java Persistence API (JPA).

### Jsoup
Библиотека для парсинга HTML и XML документов, удобно используемая для извлечения данных из веб-страниц.

### Apache Lucene Morphology
Библиотеки для морфологического анализа текста с использованием Apache Lucene, поддерживающие русский и английский языки.

- **morph** (org.apache.lucene.morphology:morph:1.5)
- **morphology** (org.apache.lucene.analysis:morphology:1.5)
- **dictionary-reader** (org.apache.lucene.morphology:dictionary-reader:1.5)
- **english** (org.apache.lucene.morphology:english:1.5)
- **russian** (org.apache.lucene.morphology:russian:1.5)

### Caffeine
Высокопроизводительный кэш для Java, используемый для ускорения доступа к данным в приложении.

### Spring Boot Starter Test
Зависимость для модульного тестирования Spring Boot приложений.

### Mockito Core
Фреймворк для создания моков и проверки поведения в модульных тестах.

### Liquibase Maven Plugin
Плагин для интеграции Liquibase с Maven, автоматизирующий процесс миграций базы данных через changelog файлы.


# Структура базы данных проекта

Этот проект использует Liquibase для создания необходимой структуры базы данных. Ниже приведены описания каждой миграции:

## Миграция 001-create-table-site.xml

Эта миграция создает таблицу `site` для хранения информации о сайтах, которые индексируются.

## Миграция 002-create-table-page.xml

Эта миграция создает таблицу `page` для хранения информации о страницах сайтов.

## Миграция 003-create-table-lemma.xml

Эта миграция создает таблицу `lemma` для хранения лемматизированных данных.

## Миграция 004-create-table-indexx.xml

Эта миграция создает таблицу `indexx` для хранения индексов страниц.

## Миграция 005-create-foreign-keys.xml

Эта миграция добавляет внешние ключи к таблицам `page`, `lemma` и `indexx`.

## Миграция 006-create-indexes.xml

Эта миграция создает индексы для таблиц `page`, `lemma` и `indexx`.


## Описание настроек

### `indexing-settings`

- **sites**: Список сайтов для индексирования. Каждый сайт указывается с URL и именем.
- **fork-join-pool**: Настройки пула ForkJoinPool.
    - **parallelism**: Количество параллельных потоков в ForkJoinPool (в данном случае 20).

### `spring`

- **datasource**: Настройки подключения к базе данных.
    - **url**: URL для подключения к MySQL базе данных на локальной машине с портом 3306 и названием базы `db`.
    - **username**: Имя пользователя для доступа к базе данных.
    - **password**: Пароль пользователя.
    - **driver-class-name**: Класс JDBC драйвера для MySQL.
    - **hikari**: Настройки пула соединений HikariCP.
        - **maximum-pool-size**: Максимальное количество соединений в пуле.
        - **minimum-idle**: Минимальное количество неактивных (idle) соединений в пуле.
        - **idle-timeout**: Время в миллисекундах, после которого неактивное соединение будет удалено из пула.
        - **connection-timeout**: Максимальное время ожидания для установки нового соединения в миллисекундах.
        - **max-lifetime**: Максимальное время жизни соединения в пуле.

### `liquibase`

- **change-log**: Путь к файлу changelog для Liquibase. Файл `changelog.xml` располагается в директории ресурсов (`classpath:/db/changelog/changelog.xml`).

### `logging`

- **level**: Настройки уровня логирования для определенных пакетов.
    - **com.zaxxer.hikari**: Уровень логирования для пакета HikariCP.
    - **java.util.concurrent.ForkJoinPool**: Уровень логирования для ForkJoinPool.

